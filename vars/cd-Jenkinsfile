pipeline {
  agent {
    kubernetes {
      inheritFrom 'jenkins-jenkins-agent'
      idleMinutes 5
      yaml '''
        apiVersion: v1
        kind: Pod
        spec:
          serviceAccountName: sa-jenkins
          automountServiceAccountToken: false
          restartPolicy: Never
          containers:
            - name: devops-tools
              image: azurecicd.azurecr.io/ubuntu-kubectl-helm:latest
              command: ["tail", "-f", "/dev/null"]
              imagePullPolicy: IfNotPresent
      '''
      defaultContainer 'devops-tools'
    }
  }

  stages {
    stage('kubctl-test') {
      steps {
        withCredentials([string(credentialsId: "default-ns-token", variable: 'TOKEN')]) {
          sh "kubectl --token=${TOKEN} get pods -A"
          sh "helm ls -A"
        }
      }
    }
  }
}
